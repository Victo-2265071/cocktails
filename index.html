<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Le Bar ‚Äî Cocktails</title>
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
<link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Josefin+Sans:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0905;
    --surface: #13110c;
    --surface2: #1c1912;
    --border: #2e2a1f;
    --gold: #c9a84c;
    --gold-light: #e8c97a;
    --gold-dim: #7a6530;
    --text: #e8e0cc;
    --text-muted: #8a8070;
    --red: #c04a3a;
    --green: #4a8c5c;
    --radius: 4px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Josefin Sans', sans-serif;
    font-weight: 300;
    font-size: 16px;
    min-height: 100vh;
    background-image: 
      radial-gradient(ellipse at 20% 0%, rgba(201,168,76,0.06) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 100%, rgba(201,168,76,0.04) 0%, transparent 50%);
  }

  /* HEADER */
  header {
    text-align: center;
    padding: 48px 24px 32px;
    border-bottom: 1px solid var(--border);
    position: relative;
  }
  header::after {
    content: '';
    position: absolute;
    bottom: -1px; left: 50%; transform: translateX(-50%);
    width: 120px; height: 1px;
    background: var(--gold);
  }
  header h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: clamp(2.5rem, 6vw, 4rem);
    font-weight: 300;
    letter-spacing: 0.12em;
    color: var(--gold-light);
    text-transform: uppercase;
  }
  header p {
    margin-top: 8px;
    font-size: 0.85rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--text-muted);
  }

  /* TABS */
  .tabs {
    display: flex;
    justify-content: center;
    gap: 0;
    padding: 32px 24px 0;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 200;
    background: var(--bg);
    transition: padding 0.3s, box-shadow 0.3s;
  }
  .tabs.scrolled {
    padding-top: 0;
    box-shadow: 0 4px 24px rgba(0,0,0,0.55);
  }
  .tab-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.82rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    padding: 14px 28px;
    cursor: pointer;
    position: relative;
    transition: color 0.3s;
    flex: 1;
    max-width: 200px;
  }
  .tab-btn::after {
    content: '';
    position: absolute;
    bottom: -1px; left: 0; right: 0;
    height: 1px;
    background: var(--gold);
    transform: scaleX(0);
    transition: transform 0.3s;
  }
  .tab-btn.active { color: var(--gold-light); }
  .tab-btn.active::after { transform: scaleX(1); }
  .tab-btn:hover { color: var(--text); }

  /* PANELS */
  .panel { display: none; padding: 40px 24px; max-width: 900px; margin: 0 auto; }
  .panel.active { display: block; animation: fadeIn 0.3s; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

  /* SECTION TITLES */
  .section-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2rem;
    font-weight: 300;
    letter-spacing: 0.08em;
    color: var(--gold);
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* INGREDIENTS PANEL */
  .ingredient-search {
    position: relative;
    margin-bottom: 28px;
  }
  .ingredient-search input {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.95rem;
    letter-spacing: 0.1em;
    padding: 16px 18px;
    outline: none;
    transition: border-color 0.3s;
  }
  .ingredient-search input:focus { border-color: var(--gold-dim); }
  .ingredient-search input::placeholder { color: var(--text-muted); }

  .ingredients-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-bottom: 40px;
  }
  .ingredient-item {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px 14px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    user-select: none;
    position: relative;
  }
  .ingredient-item:hover { border-color: var(--gold-dim); background: var(--surface2); }
  .ingredient-item.checked { border-color: var(--gold); background: rgba(201,168,76,0.08); }
  .ingredient-item .check {
    width: 16px; height: 16px;
    border: 1px solid var(--border);
    border-radius: 2px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
  }
  .ingredient-item.checked .check {
    background: var(--gold);
    border-color: var(--gold);
  }
  .ingredient-item.checked .check::after {
    content: '‚úì';
    color: var(--bg);
    font-size: 0.65rem;
    font-weight: 700;
  }
  .ingredient-item .name {
    font-size: 0.88rem;
    letter-spacing: 0.08em;
    flex: 1;
    text-transform: uppercase;
    padding-right: 40px; /* espace pour les boutons flottants */
  }
  .ingredient-item .del-ing {
    opacity: 0;
    position: absolute;
    top: 4px;
    right: 4px;
    background: var(--surface2);
    border: none;
    color: var(--red);
    cursor: pointer;
    font-size: 0.9rem;
    width: 20px; height: 20px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 2px;
    line-height: 1;
    transition: opacity 0.2s;
    z-index: 1;
  }
  .ingredient-item:hover .del-ing { opacity: 1; }

  .ingredient-item .edit-ing {
    opacity: 0;
    position: absolute;
    top: 4px;
    right: 26px;
    background: var(--surface2);
    border: none;
    color: var(--gold-dim);
    cursor: pointer;
    font-size: 0.9rem;
    width: 20px; height: 20px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 2px;
    line-height: 1;
    transition: opacity 0.2s;
    z-index: 1;
  }
  .ingredient-item:hover .edit-ing { opacity: 1; }

  .ing-edit-input {
    flex: 1;
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--gold-dim);
    color: var(--text);
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.88rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    outline: none;
    padding: 1px 0;
    width: 100%;
  }

  /* ADD INGREDIENT FORM */
  .add-row {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
  }
  .add-row input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.95rem;
    letter-spacing: 0.1em;
    padding: 14px 16px;
    outline: none;
    transition: border-color 0.3s;
  }
  .add-row input:focus { border-color: var(--gold-dim); }
  .add-row input::placeholder { color: var(--text-muted); }

  .btn {
    background: none;
    border: 1px solid var(--gold-dim);
    color: var(--gold);
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.82rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    padding: 13px 22px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn:hover { background: rgba(201,168,76,0.1); border-color: var(--gold); }
  .btn.primary { background: var(--gold); color: var(--bg); border-color: var(--gold); font-weight: 400; }
  .btn.primary:hover { background: var(--gold-light); }
  .btn.danger { border-color: var(--red); color: var(--red); }
  .btn.danger:hover { background: rgba(192,74,58,0.12); }

  /* RECIPES PANEL */
  .recipes-toolbar {
    display: flex;
    gap: 10px;
    margin-bottom: 28px;
    flex-wrap: wrap;
    align-items: center;
  }
  .recipes-toolbar input {
    flex: 1;
    min-width: 200px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.95rem;
    letter-spacing: 0.1em;
    padding: 14px 16px;
    outline: none;
    transition: border-color 0.3s;
  }
  .recipes-toolbar input:focus { border-color: var(--gold-dim); }
  .recipes-toolbar input::placeholder { color: var(--text-muted); }

  .filter-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.82rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-muted);
    cursor: pointer;
    user-select: none;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    transition: all 0.2s;
  }
  .filter-toggle:hover { border-color: var(--gold-dim); color: var(--text); }
  .filter-toggle.on { border-color: var(--gold); color: var(--gold); }
  .filter-toggle .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--border);
    transition: background 0.2s;
  }
  .filter-toggle.on .dot { background: var(--gold); }

  .recipes-list { display: flex; flex-direction: column; gap: 12px; }

  .recipe-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .recipe-card:hover { border-color: var(--gold-dim); }
  .recipe-card.makeable { border-color: rgba(74,140,92,0.5); }

  .recipe-header {
    display: flex;
    align-items: center;
    padding: 18px 20px;
    cursor: pointer;
    gap: 12px;
  }
  .recipe-header .rname {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.5rem;
    font-weight: 400;
    letter-spacing: 0.06em;
    flex: 1;
  }
  .recipe-header .badge {
    font-size: 0.72rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 4px 10px;
    border-radius: 2px;
  }
  .badge.ok { background: rgba(74,140,92,0.15); color: #6dbd8a; border: 1px solid rgba(74,140,92,0.3); }
  .badge.missing { background: rgba(192,74,58,0.1); color: #e07060; border: 1px solid rgba(192,74,58,0.2); }
  .recipe-header .arrow {
    color: var(--text-muted);
    font-size: 0.7rem;
    transition: transform 0.2s;
  }
  .recipe-card.open .recipe-header .arrow { transform: rotate(180deg); }

  .recipe-body {
    display: none;
    padding: 0 20px 18px;
    border-top: 1px solid var(--border);
  }
  .recipe-card.open .recipe-body { display: block; }

  .ingredients-list {
    margin-top: 14px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .ing-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid rgba(46,42,31,0.5);
    font-size: 0.88rem;
    letter-spacing: 0.08em;
  }
  .ing-row:last-child { border-bottom: none; }
  .ing-row .ing-name { text-transform: uppercase; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
  .ing-row .ing-qty { color: var(--gold); font-style: italic; font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; }
  .ing-row.missing-ing .ing-name { color: var(--text-muted); text-decoration: line-through; }

  .recipe-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    justify-content: flex-end;
  }

  /* MANAGE PANEL */
  .manage-form {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    margin-bottom: 32px;
  }
  .form-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.5rem;
    color: var(--gold);
    margin-bottom: 20px;
    letter-spacing: 0.08em;
  }
  .form-group {
    margin-bottom: 16px;
  }
  .form-group label {
    display: block;
    font-size: 0.78rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 8px;
  }
  .form-group input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.95rem;
    letter-spacing: 0.1em;
    padding: 13px 16px;
    outline: none;
    transition: border-color 0.3s;
  }
  .form-group input:focus { border-color: var(--gold-dim); }
  .form-group input::placeholder { color: var(--text-muted); }

  .form-ing-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
  .form-ing-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .form-ing-row input:first-child { flex: 2; }
  .form-ing-row input:last-of-type { flex: 1; }
  .form-ing-row .remove-ing {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    width: 36px; height: 36px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 1rem;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
  }
  .form-ing-row .remove-ing:hover { border-color: var(--red); color: var(--red); }

  .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

  /* AUTOCOMPLETE */
  .autocomplete-wrapper { position: relative; flex: 2; }
  .autocomplete-dropdown {
    position: absolute;
    top: 100%;
    left: 0; right: 0;
    background: var(--surface2);
    border: 1px solid var(--gold-dim);
    border-top: none;
    border-radius: 0 0 var(--radius) var(--radius);
    z-index: 100;
    max-height: 240px;
    overflow-y: auto;
  }
  .autocomplete-dropdown div {
    padding: 12px 14px;
    font-size: 0.88rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: background 0.15s;
  }
  .autocomplete-dropdown div:hover { background: rgba(201,168,76,0.1); }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 32px; left: 50%; transform: translateX(-50%);
    background: var(--surface2);
    border: 1px solid var(--gold-dim);
    color: var(--gold-light);
    font-size: 0.85rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 12px 24px;
    border-radius: var(--radius);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 1000;
  }
  .toast.show { opacity: 1; }

  /* EMPTY STATE */
  .empty {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }
  .empty .icon { font-size: 2.5rem; margin-bottom: 16px; opacity: 0.4; }
  .empty p { font-size: 0.88rem; letter-spacing: 0.15em; text-transform: uppercase; }

  /* SELECT */
  select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.9rem;
    padding: 12px 16px;
    outline: none;
    cursor: pointer;
  }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* STARS */
  .stars-display { display: inline-flex; gap: 2px; }
  .stars-display .star { font-size: 0.85rem; color: var(--border); }
  .stars-display .star.on { color: var(--gold); }

  .stars-input { display: inline-flex; gap: 4px; }
  .stars-input .star-btn {
    background: none; border: none; cursor: pointer;
    font-size: 1.4rem; color: var(--border);
    transition: color 0.15s; padding: 0 1px;
    line-height: 1;
  }
  .stars-input .star-btn.on { color: var(--gold); }
  .stars-input .star-btn:hover { color: var(--gold-light); }

  /* ING ROW FLAGS */
  .ing-row .ing-flags { display: flex; gap: 4px; align-items: center; margin-left: 6px; }
  .flag-pill {
    font-size: 0.68rem; letter-spacing: 0.12em; text-transform: uppercase;
    padding: 3px 7px; border-radius: 2px; white-space: nowrap;
  }
  .flag-shake { background: rgba(201,168,76,0.12); color: var(--gold-dim); border: 1px solid rgba(201,168,76,0.25); }
  .flag-optional { background: rgba(138,128,112,0.12); color: var(--text-muted); border: 1px solid rgba(138,128,112,0.2); font-style: italic; }

  /* TOPPING SECTION */
  .topping-divider {
    display: flex; align-items: center; gap: 10px;
    margin: 12px 0 8px;
    font-size: 0.72rem; letter-spacing: 0.22em; text-transform: uppercase;
    color: var(--text-muted);
  }
  .topping-divider::before, .topping-divider::after {
    content: ''; flex: 1; height: 1px; background: var(--border);
  }

  /* FORM ING PILLS (shake / optional toggles) */
  .ing-pill-toggle {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-muted);
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.72rem; letter-spacing: 0.12em; text-transform: uppercase;
    padding: 0 10px; height: 40px;
    border-radius: var(--radius); cursor: pointer; white-space: nowrap;
    flex-shrink: 0;
    transition: all 0.2s;
  }
  .ing-pill-toggle:hover { border-color: var(--gold-dim); color: var(--text); }
  .ing-pill-toggle.active-shake { border-color: var(--gold-dim); color: var(--gold); background: rgba(201,168,76,0.08); }
  .ing-pill-toggle.active-optional { border-color: var(--text-muted); color: var(--text); background: rgba(138,128,112,0.1); }

  /* FORM SECTION LABEL */
  .form-section-label {
    font-size: 0.72rem; letter-spacing: 0.22em; text-transform: uppercase;
    color: var(--text-muted); margin: 18px 0 8px;
    display: flex; align-items: center; gap: 8px;
  }
  .form-section-label::after { content: ''; flex:1; height:1px; background: var(--border); }
  .glass-icon { display: inline-flex; align-items: center; }
  .glass-icon svg { width: 20px; height: 20px; fill: var(--gold-dim); flex-shrink: 0; }

  /* RECIPE META ROW */
  .recipe-meta {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 20px 0;
    flex-wrap: wrap;
  }

  /* NOTES */
  .recipe-notes-section {
    margin-top: 14px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }
  .recipe-notes-label {
    font-size: 0.72rem; letter-spacing: 0.2em; text-transform: uppercase;
    color: var(--text-muted); margin-bottom: 6px;
  }
  .recipe-notes-text {
    font-size: 0.95rem; color: var(--text); line-height: 1.7;
    white-space: pre-wrap; font-family: 'Cormorant Garamond', serif;
    font-style: italic;
  }

  .form-group textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.95rem;
    letter-spacing: 0.06em;
    padding: 13px 16px;
    outline: none;
    transition: border-color 0.3s;
    resize: vertical;
    min-height: 80px;
  }
  .form-group textarea:focus { border-color: var(--gold-dim); }
  .form-group textarea::placeholder { color: var(--text-muted); }

  .form-group select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.95rem;
    letter-spacing: 0.08em;
    padding: 13px 16px;
    outline: none;
    cursor: pointer;
    appearance: none;
    transition: border-color 0.3s;
  }
  .form-group select:focus { border-color: var(--gold-dim); }

  /* GLASS FILTER ‚Äî remplac√© par le panneau unifi√© */

  /* FILTER BUTTON + PANEL */
  .filter-btn-wrap {
    position: relative;
  }
  .filter-main-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
  }
  .filter-main-btn.has-filters {
    border-color: var(--gold);
    color: var(--gold-light);
  }
  .filter-count-badge {
    background: var(--gold);
    color: var(--bg);
    font-size: 0.65rem;
    font-weight: 700;
    border-radius: 999px;
    padding: 1px 6px;
    min-width: 18px;
    text-align: center;
  }
  .filter-panel {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    min-width: 320px;
    background: var(--surface2);
    border: 1px solid var(--gold-dim);
    border-radius: 6px;
    z-index: 300;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    overflow: hidden;
  }

  /* Row header (cliquable pour ouvrir/fermer) */
  .frow {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 13px 18px;
    cursor: pointer;
    transition: background 0.15s;
    user-select: none;
  }
  .frow:hover { background: rgba(201,168,76,0.05); }
  .frow-label {
    font-size: 0.78rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--text-muted);
    flex: 1;
  }
  .frow-val {
    font-size: 0.82rem;
    letter-spacing: 0.08em;
    color: var(--gold);
    max-width: 130px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .frow-val.unset { color: var(--text-muted); }
  .frow-arrow {
    color: var(--text-muted);
    font-size: 1rem;
    transition: transform 0.2s;
    line-height: 1;
  }
  .frow-arrow.open { transform: rotate(90deg); }

  /* Sous-section d√©pliable */
  .fsection {
    padding: 4px 18px 14px;
    border-top: 1px solid rgba(46,42,31,0.6);
    background: rgba(0,0,0,0.15);
  }

  .filter-panel-section {
    padding: 12px 18px;
  }
  .filter-panel-label {
    font-size: 0.72rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 10px;
  }
  .filter-panel-divider {
    height: 1px;
    background: var(--border);
  }
  .filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .filter-chip {
    background: none;
    border: 1px solid var(--border);
    border-radius: 3px;
    color: var(--text-muted);
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.78rem;
    letter-spacing: 0.1em;
    padding: 6px 12px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .filter-chip:hover { border-color: var(--gold-dim); color: var(--text); }
  .filter-chip.active { border-color: var(--gold); color: var(--gold-light); background: rgba(201,168,76,0.1); }

  /* Ingredient search inside panel */
  .fing-search-wrap { position: relative; margin-top: 4px; }
  .fing-input {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.88rem;
    letter-spacing: 0.08em;
    padding: 10px 12px;
    outline: none;
    transition: border-color 0.2s;
  }
  .fing-input:focus { border-color: var(--gold-dim); }
  .fing-input::placeholder { color: var(--text-muted); }
  .fing-dropdown {
    position: absolute;
    top: 100%; left: 0; right: 0;
    background: var(--surface2);
    border: 1px solid var(--gold-dim);
    border-top: none;
    border-radius: 0 0 var(--radius) var(--radius);
    z-index: 400;
    max-height: 180px;
    overflow-y: auto;
  }
  .fing-dropdown div {
    padding: 10px 12px;
    font-size: 0.85rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: background 0.12s;
  }
  .fing-dropdown div:hover { background: rgba(201,168,76,0.1); }
  .fing-active-tag {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    background: rgba(201,168,76,0.1);
    border: 1px solid var(--gold-dim);
    border-radius: 3px;
    padding: 6px 10px;
    font-size: 0.82rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--gold-light);
  }
  .fing-clear {
    background: none; border: none; color: var(--text-muted);
    cursor: pointer; font-size: 1rem; padding: 0; line-height: 1;
    margin-left: auto;
    transition: color 0.15s;
  }
  .fing-clear:hover { color: var(--red); }

  /* Rating stars inside filter panel */
  .frating-stars-wrap {
    padding: 4px 0 6px;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .frating-stars-wrap .stars-input { gap: 6px; }
  .frating-stars-wrap .star-btn { font-size: 1.6rem; }

  .filter-panel-footer {
    padding: 10px 18px 14px;
    display: flex;
    justify-content: flex-end;
    border-top: 1px solid var(--border);
  }

  /* ‚îÄ‚îÄ‚îÄ RESPONSIVE / MOBILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

  /* Form ingredient rows on small screens */
  @media (max-width: 600px) {
    header {
      padding: 32px 16px 24px;
    }
    header h1 {
      font-size: clamp(2rem, 10vw, 3rem);
    }
    header p {
      font-size: 0.72rem;
      letter-spacing: 0.2em;
    }

    .tabs {
      padding: 0;
    }
    .tab-btn {
      font-size: 0.72rem;
      letter-spacing: 0.15em;
      padding: 14px 8px;
    }

    .panel {
      padding: 24px 16px;
    }

    .section-title {
      font-size: 1.6rem;
    }

    /* Ingredient grid: 1 colonne sur mobile */
    .ingredients-grid {
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .ingredient-item {
      padding: 10px 12px;
    }
    .ingredient-item .name {
      font-size: 0.8rem;
    }

    /* Add ingredient row: stacked */
    .add-row {
      flex-direction: column;
    }
    .add-row .btn {
      width: 100%;
    }

    /* Recipes toolbar: stacked */
    .recipes-toolbar {
      flex-direction: column;
      gap: 8px;
    }
    .recipes-toolbar input,
    .filter-btn-wrap,
    .filter-toggle {
      width: 100%;
    }
    .filter-panel {
      min-width: unset;
      width: 100%;
    }
    .btn.primary[onclick*="startNew"] {
      width: 100%;
      text-align: center;
    }

    /* Recipe cards */
    .recipe-header {
      padding: 14px 16px;
      gap: 8px;
    }
    .recipe-header .rname {
      font-size: 1.25rem;
    }
    /* Verre + √©toiles empil√©s verticalement sur mobile */
    .recipe-header .recipe-meta-wrap {
      flex-direction: column;
      align-items: flex-start;
      gap: 1px;
    }
    /* Badge: ic√¥ne uniquement sur mobile */
    .recipe-header .badge {
      font-size: 0;
      padding: 5px 7px;
      line-height: 1;
    }
    .recipe-header .badge.ok::before  { content: '‚úì'; font-size: 0.85rem; color: #6dbd8a; }
    .recipe-header .badge.missing::before { content: '‚úï'; font-size: 0.85rem; color: #e07060; }
    .recipe-body {
      padding: 0 16px 14px;
    }
    .ing-row {
      font-size: 0.82rem;
      padding: 8px 0;
    }
    .recipe-actions {
      flex-wrap: wrap;
    }
    .recipe-actions .btn {
      flex: 1;
      text-align: center;
    }

    /* Manage form */
    .manage-form {
      padding: 20px 16px;
    }

    /* Form ingredient rows: wrap on mobile */
    .form-ing-row {
      flex-wrap: wrap;
      gap: 6px;
    }
    .form-ing-row .autocomplete-wrapper {
      flex: 1 1 calc(60% - 6px);
      min-width: 120px;
    }
    .form-ing-row .qty-input {
      flex: 1 1 calc(40% - 6px);
      min-width: 80px;
    }
    .form-ing-row .ing-pill-toggle {
      flex: 1 1 calc(50% - 3px);
      font-size: 0.68rem;
    }
    .form-ing-row .remove-ing {
      flex: 0 0 36px;
    }

    /* Form actions: full width buttons */
    .form-actions {
      flex-direction: column-reverse;
      gap: 8px;
    }
    .form-actions .btn {
      width: 100%;
      text-align: center;
    }

    /* Stars plus petites dans le formulaire sur mobile */
    .stars-input .star-btn {
      font-size: 1.4rem;
      padding: 0 1px;
    }

    /* Toast at bottom with more room for thumb */
    .toast {
      bottom: 24px;
      width: calc(100% - 32px);
      text-align: center;
    }
  }

  /* ‚îÄ‚îÄ‚îÄ FAVOURITE STAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .fav-btn {
    background: none; border: none; cursor: pointer;
    font-size: 1.4rem; line-height: 1;
    color: var(--border);
    padding: 0 4px 0 0;
    flex-shrink: 0;
    transition: color 0.2s, transform 0.15s;
  }
  .fav-btn:hover { transform: scale(1.2); }
  .fav-btn.on { color: var(--gold); }

  /* ‚îÄ‚îÄ‚îÄ TAGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .tag-btn-wrap { position: relative; margin-bottom: 16px; }
  .tag-toggle-btn {
    display: flex; align-items: center; gap: 8px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: var(--radius); color: var(--text-muted);
    font-family: 'Josefin Sans', sans-serif; font-size: 0.78rem;
    letter-spacing: 0.2em; text-transform: uppercase;
    padding: 11px 16px; cursor: pointer; transition: all 0.2s;
    width: 100%;
  }
  .tag-toggle-btn:hover { border-color: var(--gold-dim); color: var(--text); }
  .tag-toggle-btn.has-tags { border-color: var(--gold-dim); color: var(--gold); }
  .tag-count-badge {
    background: var(--gold); color: var(--bg); font-size: 0.65rem;
    font-weight: 700; border-radius: 999px; padding: 1px 6px;
    min-width: 18px; text-align: center;
  }
  .tag-panel {
    position: absolute; top: calc(100% + 6px); left: 0; right: 0;
    background: var(--surface2); border: 1px solid var(--gold-dim);
    border-radius: 6px; z-index: 400; box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    max-height: 420px; overflow-y: auto;
  }
  .tag-section { padding: 12px 16px 10px; }
  .tag-section + .tag-section { border-top: 1px solid var(--border); }
  .tag-section-label {
    font-size: 0.7rem; letter-spacing: 0.22em; text-transform: uppercase;
    color: var(--text-muted); margin-bottom: 8px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .tag-section-limit { font-size: 0.65rem; opacity: 0.6; }
  .tag-chips { display: flex; flex-wrap: wrap; gap: 6px; }
  .tag-chip {
    background: none; border: 1px solid var(--border); border-radius: 3px;
    color: var(--text-muted); font-family: 'Josefin Sans', sans-serif;
    font-size: 0.75rem; letter-spacing: 0.08em; padding: 5px 10px;
    cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }
  .tag-chip:hover { border-color: var(--gold-dim); color: var(--text); }
  .tag-chip.active { border-color: var(--gold); color: var(--gold-light); background: rgba(201,168,76,0.1); }
  .tag-chip.disabled { opacity: 0.35; cursor: not-allowed; }

  /* Tag pills displayed on recipe cards */
  .recipe-tags {
    display: flex; flex-wrap: wrap; gap: 5px;
    padding: 0 20px 10px;
  }
  .recipe-tag-pill {
    font-size: 0.68rem; letter-spacing: 0.1em; text-transform: uppercase;
    padding: 3px 9px; border-radius: 2px;
    border: 1px solid var(--border); color: var(--text-muted);
    background: rgba(255,255,255,0.02);
  }
  .recipe-tag-pill.profil { border-color: rgba(201,168,76,0.3); color: rgba(201,168,76,0.7); }
  .recipe-tag-pill.texture { border-color: rgba(74,140,180,0.3); color: rgba(100,170,210,0.7); }
  .recipe-tag-pill.sucre { border-color: rgba(180,120,74,0.3); color: rgba(210,150,100,0.7); }
  .recipe-tag-pill.complexite { border-color: rgba(140,100,180,0.3); color: rgba(170,130,210,0.7); }

  /* Medium: tablet adjustments */
  @media (min-width: 601px) and (max-width: 900px) {
    .panel {
      padding: 32px 20px;
    }
    .ingredients-grid {
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    }
    .form-ing-row {
      flex-wrap: wrap;
    }
    .form-ing-row .autocomplete-wrapper {
      flex: 2 1 180px;
    }
    .form-ing-row .qty-input {
      flex: 1 1 100px;
    }
  }
</style>
</head>
<body>

<header>
  <h1>Le Bar</h1>
  <p>Votre carnet de recettes de cocktails</p>
  <button onclick="reconfigure()" style="position:absolute;top:16px;right:16px;background:none;border:1px solid var(--border);color:var(--text-muted);font-family:'Josefin Sans',sans-serif;font-size:0.75rem;letter-spacing:0.2em;text-transform:uppercase;padding:10px 16px;border-radius:4px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--gold-dim)';this.style.color='var(--text)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)'">‚öô GitHub</button>
</header>

<div class="tabs">
  <button class="tab-btn active" onclick="showTab('ingredients')">Mes Ingr√©dients</button>
  <button class="tab-btn" onclick="showTab('recipes')">Recettes</button>
  <button class="tab-btn" onclick="showTab('manage')">G√©rer</button>
</div>

<!-- PANEL 1: INGREDIENTS -->
<div id="panel-ingredients" class="panel active">
  <div class="section-title">Ingr√©dients disponibles</div>
  <div class="ingredient-search">
    <input type="text" id="ing-filter" placeholder="Filtrer les ingr√©dients‚Ä¶" oninput="renderIngredients()">
  </div>
  <div id="ingredients-grid" class="ingredients-grid"></div>
  <div class="section-title">Ajouter un ingr√©dient</div>
  <div class="add-row">
    <input type="text" id="new-ing-name" placeholder="Nom de l'ingr√©dient‚Ä¶" onkeydown="if(event.key==='Enter')addIngredient()">
    <button class="btn primary" onclick="addIngredient()">Ajouter</button>
  </div>
</div>

<!-- PANEL 2: RECIPES -->
<div id="panel-recipes" class="panel">
  <div class="recipes-toolbar">
    <input type="text" id="recipe-filter" placeholder="Rechercher une recette‚Ä¶" oninput="renderRecipes()">
    <div class="filter-btn-wrap">
      <button class="btn filter-main-btn" id="filter-main-btn" onclick="toggleFilterPanel()">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="flex-shrink:0"><path d="M1 3h12M3 7h8M5 11h4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>
        Filtres
        <span class="filter-count-badge" id="filter-count-badge" style="display:none"></span>
      </button>
      <div class="filter-panel" id="filter-panel" style="display:none">

        <!-- Type de verre -->
        <div class="frow" onclick="toggleFSection('fsec-glass')">
          <span class="frow-label">Type de verre</span>
          <span class="frow-val unset" id="fval-glass">Tous</span>
          <span class="frow-arrow" id="farr-glass">‚Ä∫</span>
        </div>
        <div class="fsection" id="fsec-glass" style="display:none">
          <div class="filter-chips" id="glass-chips">
            <button class="filter-chip active" data-val="" onclick="selectGlass(this)">Tous</button>
            <button class="filter-chip" data-val="shooter" onclick="selectGlass(this)">ü•É Shooter</button>
            <button class="filter-chip" data-val="highball" onclick="selectGlass(this)">ü•§ Highball</button>
            <button class="filter-chip" data-val="lowball" onclick="selectGlass(this)">ü•É Rocks</button>
            <button class="filter-chip" data-val="coupe" onclick="selectGlass(this)">üç∏ Coupe</button>
            <button class="filter-chip" data-val="martini" onclick="selectGlass(this)">üç∏ Martini</button>
            <button class="filter-chip" data-val="hurricane" onclick="selectGlass(this)">üåÄ Hurricane</button>
            <button class="filter-chip" data-val="flute" onclick="selectGlass(this)">ü•Ç Fl√ªte</button>
            <button class="filter-chip" data-val="mug" onclick="selectGlass(this)">‚òï Mug</button>
            <button class="filter-chip" data-val="autre" onclick="selectGlass(this)">‚ñ¢ Autre</button>
          </div>
        </div>
        <div class="filter-panel-divider"></div>

        <!-- Ingr√©dient -->
        <div class="frow" onclick="toggleFSection('fsec-ing')">
          <span class="frow-label">Ingr√©dient</span>
          <span class="frow-val unset" id="fval-ing">Tous</span>
          <span class="frow-arrow" id="farr-ing">‚Ä∫</span>
        </div>
        <div class="fsection" id="fsec-ing" style="display:none">
          <div class="fing-search-wrap">
            <input type="text" id="fing-input" class="fing-input" placeholder="Rechercher un ingr√©dient‚Ä¶"
              oninput="showFilterIngAC(this)" onfocus="showFilterIngAC(this)" autocomplete="off">
            <div class="fing-dropdown" id="fing-dropdown" style="display:none"></div>
          </div>
          <div id="fing-active-tag" style="display:none" class="fing-active-tag">
            <span id="fing-active-name"></span>
            <button onclick="clearIngFilter()" class="fing-clear">√ó</button>
          </div>
        </div>
        <div class="filter-panel-divider"></div>

        <!-- Note minimale -->
        <div class="frow" onclick="toggleFSection('fsec-rating')">
          <span class="frow-label">Note minimale</span>
          <span class="frow-val unset" id="fval-rating">Toutes</span>
          <span class="frow-arrow" id="farr-rating">‚Ä∫</span>
        </div>
        <div class="fsection" id="fsec-rating" style="display:none">
          <div class="frating-stars-wrap">
            <div class="stars-input" id="frating-stars">
              <button type="button" class="star-btn" data-val="1" onclick="selectFilterRating(1)">‚òÖ</button>
              <button type="button" class="star-btn" data-val="2" onclick="selectFilterRating(2)">‚òÖ</button>
              <button type="button" class="star-btn" data-val="3" onclick="selectFilterRating(3)">‚òÖ</button>
              <button type="button" class="star-btn" data-val="4" onclick="selectFilterRating(4)">‚òÖ</button>
              <button type="button" class="star-btn" data-val="5" onclick="selectFilterRating(5)">‚òÖ</button>
              <button type="button" class="star-btn" style="font-size:0.8rem;color:var(--text-muted);letter-spacing:0.1em;" onclick="selectFilterRating(0)">‚úï</button>
            </div>
          </div>
        </div>
        <div class="filter-panel-divider"></div>

        <!-- Shake -->
        <div class="frow" onclick="toggleFSection('fsec-shake')">
          <span class="frow-label">Shake</span>
          <span class="frow-val unset" id="fval-shake">Peu importe</span>
          <span class="frow-arrow" id="farr-shake">‚Ä∫</span>
        </div>
        <div class="fsection" id="fsec-shake" style="display:none">
          <div class="filter-chips">
            <button class="filter-chip active" data-val="" onclick="selectShake(this)">Peu importe</button>
            <button class="filter-chip" data-val="yes" onclick="selectShake(this)">Shake requis</button>
            <button class="filter-chip" data-val="no" onclick="selectShake(this)">Sans shake</button>
          </div>
        </div>
        <div class="filter-panel-divider"></div>

        <!-- Tags -->
        <div class="frow" onclick="toggleFSection('fsec-tags')">
          <span class="frow-label">Tags</span>
          <span class="frow-val unset" id="fval-tags">Tous</span>
          <span class="frow-arrow" id="farr-tags">‚Ä∫</span>
        </div>
        <div class="fsection" id="fsec-tags" style="display:none">
          <div style="font-size:0.7rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--text-muted);margin:6px 0 5px;">Profil</div>
          <div class="filter-chips" id="ftags-profil">
            <button class="filter-chip" data-tag="Sucr√©" onclick="toggleFilterTag(this)">Sucr√©</button>
            <button class="filter-chip" data-tag="Sec" onclick="toggleFilterTag(this)">Sec</button>
            <button class="filter-chip" data-tag="Amer" onclick="toggleFilterTag(this)">Amer</button>
            <button class="filter-chip" data-tag="Acide / Sour" onclick="toggleFilterTag(this)">Acide / Sour</button>
            <button class="filter-chip" data-tag="Fruit√©" onclick="toggleFilterTag(this)">Fruit√©</button>
            <button class="filter-chip" data-tag="Herbac√©" onclick="toggleFilterTag(this)">Herbac√©</button>
            <button class="filter-chip" data-tag="√âpic√©" onclick="toggleFilterTag(this)">√âpic√©</button>
            <button class="filter-chip" data-tag="Florale" onclick="toggleFilterTag(this)">Florale</button>
            <button class="filter-chip" data-tag="Bois√©" onclick="toggleFilterTag(this)">Bois√©</button>
            <button class="filter-chip" data-tag="Caram√©lis√©" onclick="toggleFilterTag(this)">Caram√©lis√©</button>
            <button class="filter-chip" data-tag="Caf√© / Chocolat√©" onclick="toggleFilterTag(this)">Caf√© / Chocolat√©</button>
          </div>
          <div style="font-size:0.7rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--text-muted);margin:10px 0 5px;">Texture</div>
          <div class="filter-chips" id="ftags-texture">
            <button class="filter-chip" data-tag="Cr√©meux" onclick="toggleFilterTag(this)">Cr√©meux</button>
            <button class="filter-chip" data-tag="Onctueux" onclick="toggleFilterTag(this)">Onctueux</button>
            <button class="filter-chip" data-tag="L√©ger" onclick="toggleFilterTag(this)">L√©ger</button>
            <button class="filter-chip" data-tag="Sirupeux" onclick="toggleFilterTag(this)">Sirupeux</button>
            <button class="filter-chip" data-tag="P√©tillant" onclick="toggleFilterTag(this)">P√©tillant</button>
          </div>
          <div style="font-size:0.7rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--text-muted);margin:10px 0 5px;">Sucre</div>
          <div class="filter-chips" id="ftags-sucre">
            <button class="filter-chip" data-tag="Tr√®s sucr√©" onclick="toggleFilterTag(this)">Tr√®s sucr√©</button>
            <button class="filter-chip" data-tag="Sucr√©" onclick="toggleFilterTag(this)">Sucr√©</button>
            <button class="filter-chip" data-tag="√âquilibr√©" onclick="toggleFilterTag(this)">√âquilibr√©</button>
            <button class="filter-chip" data-tag="Peu sucr√©" onclick="toggleFilterTag(this)">Peu sucr√©</button>
            <button class="filter-chip" data-tag="Non-sucr√©" onclick="toggleFilterTag(this)">Non-sucr√©</button>
          </div>
          <div style="font-size:0.7rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--text-muted);margin:10px 0 5px;">Complexit√©</div>
          <div class="filter-chips" id="ftags-complexite">
            <button class="filter-chip" data-tag="Simple" onclick="toggleFilterTag(this)">Simple</button>
            <button class="filter-chip" data-tag="Interm√©diaire" onclick="toggleFilterTag(this)">Interm√©diaire</button>
            <button class="filter-chip" data-tag="Complexe" onclick="toggleFilterTag(this)">Complexe</button>
          </div>
        </div>
        <div class="filter-panel-divider"></div>

        <!-- Booleans -->
        <div class="filter-panel-section" style="padding-top:10px;padding-bottom:10px;">
          <div class="filter-chips">
            <button class="filter-chip" id="chip-favorites" onclick="toggleFilterChip(this,'favorites')">‚òÖ Favoris</button>
            <button class="filter-chip" id="chip-makeable" onclick="toggleFilterChip(this,'makeable')">‚úì R√©alisables</button>
          </div>
        </div>

        <div class="filter-panel-footer">
          <button class="btn" style="font-size:0.75rem;padding:8px 14px;" onclick="resetFilters()">R√©initialiser</button>
        </div>
      </div>
    </div>
    <button class="btn primary" onclick="showTab('manage'); startNew()">+ Nouvelle recette</button>
  </div>
  <div id="recipes-list" class="recipes-list"></div>
</div>

<!-- PANEL 3: MANAGE -->
<div id="panel-manage" class="panel">
  <div class="section-title">Cr√©er / Modifier une recette</div>
  <div class="manage-form">
    <div class="form-title" id="form-title">Nouvelle recette</div>
    <input type="hidden" id="edit-id">
    <div class="form-group">
      <label>Nom du cocktail</label>
      <input type="text" id="recipe-name" placeholder="Ex: Old Fashioned">
    </div>
    <div style="display:flex;gap:16px;flex-wrap:wrap;">
      <div class="form-group" style="flex:1;min-width:160px;">
        <label>Type de verre</label>
        <select id="recipe-glass">
          <option value="">‚Äî Non sp√©cifi√© ‚Äî</option>
          <option value="shooter">Shooter</option>
          <option value="highball">Verre highball</option>
          <option value="lowball">Verre bas (rocks)</option>
          <option value="coupe">Coupe</option>
          <option value="martini">Martini</option>
          <option value="hurricane">Hurricane</option>
          <option value="flute">Fl√ªte</option>
          <option value="mug">Mug / Tasse</option>
          <option value="autre">Autre</option>
        </select>
      </div>
      <div class="form-group" style="flex:1;min-width:160px;">
        <label>Note</label>
        <div class="stars-input" id="rating-input">
          <button type="button" class="star-btn" data-val="1" onclick="setRating(1)">‚òÖ</button>
          <button type="button" class="star-btn" data-val="2" onclick="setRating(2)">‚òÖ</button>
          <button type="button" class="star-btn" data-val="3" onclick="setRating(3)">‚òÖ</button>
          <button type="button" class="star-btn" data-val="4" onclick="setRating(4)">‚òÖ</button>
          <button type="button" class="star-btn" data-val="5" onclick="setRating(5)">‚òÖ</button>
          <button type="button" class="star-btn" style="font-size:0.8rem;color:var(--text-muted);letter-spacing:0.1em;" onclick="setRating(0)">‚úï</button>
        </div>
        <input type="hidden" id="recipe-rating" value="0">
      </div>
    </div>
    <div class="form-group">
      <label>Notes personnelles</label>
      <textarea id="recipe-notes" placeholder="Conseils, variantes, anecdotes‚Ä¶"></textarea>
    </div>
    <div class="form-group">
      <label>Tags</label>
      <div class="tag-btn-wrap" id="form-tag-wrap">
        <button type="button" class="tag-toggle-btn" id="form-tag-toggle-btn" onclick="toggleTagPanel()">
          <svg width="13" height="13" viewBox="0 0 13 13" fill="none" style="flex-shrink:0"><path d="M1 6.5h11M6.5 1v11" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>
          <span id="form-tag-btn-label">Ajouter des tags</span>
          <span class="tag-count-badge" id="form-tag-count" style="display:none"></span>
        </button>
        <div class="tag-panel" id="form-tag-panel" style="display:none">
          <!-- Profil -->
          <div class="tag-section">
            <div class="tag-section-label">Profil <span class="tag-section-limit">0 √† 3</span></div>
            <div class="tag-chips" id="tag-chips-profil">
              <button type="button" class="tag-chip" data-section="profil" data-val="Sucr√©" onclick="toggleTag(this)">Sucr√©</button>
              <button type="button" class="tag-chip" data-section="profil" data-val="Sec" onclick="toggleTag(this)">Sec</button>
              <button type="button" class="tag-chip" data-section="profil" data-val="Amer" onclick="toggleTag(this)">Amer</button>
              <button type="button" class="tag-chip" data-section="profil" data-val="Acide / Sour" onclick="toggleTag(this)">Acide / Sour</button>
              <button type="button" class="tag-chip" data-section="profil" data-val="Fruit√©" onclick="toggleTag(this)">Fruit√©</button>
              <button type="button" class="tag-chip" data-section="profil" data-val="Herbac√©" onclick="toggleTag(this)">Herbac√©</button>
              <button type="button" class="tag-chip" data-section="profil" data-val="√âpic√©" onclick="toggleTag(this)">√âpic√©</button>
              <button type="button" class="tag-chip" data-section="profil" data-val="Florale" onclick="toggleTag(this)">Florale</button>
              <button type="button" class="tag-chip" data-section="profil" data-val="Bois√©" onclick="toggleTag(this)">Bois√©</button>
              <button type="button" class="tag-chip" data-section="profil" data-val="Caram√©lis√©" onclick="toggleTag(this)">Caram√©lis√©</button>
              <button type="button" class="tag-chip" data-section="profil" data-val="Caf√© / Chocolat√©" onclick="toggleTag(this)">Caf√© / Chocolat√©</button>
            </div>
          </div>
          <!-- Texture -->
          <div class="tag-section">
            <div class="tag-section-label">Texture <span class="tag-section-limit">0 ou 1</span></div>
            <div class="tag-chips" id="tag-chips-texture">
              <button type="button" class="tag-chip" data-section="texture" data-val="Cr√©meux" onclick="toggleTag(this)">Cr√©meux</button>
              <button type="button" class="tag-chip" data-section="texture" data-val="Onctueux" onclick="toggleTag(this)">Onctueux</button>
              <button type="button" class="tag-chip" data-section="texture" data-val="L√©ger" onclick="toggleTag(this)">L√©ger</button>
              <button type="button" class="tag-chip" data-section="texture" data-val="Sirupeux" onclick="toggleTag(this)">Sirupeux</button>
              <button type="button" class="tag-chip" data-section="texture" data-val="P√©tillant" onclick="toggleTag(this)">P√©tillant</button>
            </div>
          </div>
          <!-- Sucre -->
          <div class="tag-section">
            <div class="tag-section-label">Sucre <span class="tag-section-limit">0 ou 1</span></div>
            <div class="tag-chips" id="tag-chips-sucre">
              <button type="button" class="tag-chip" data-section="sucre" data-val="Tr√®s sucr√©" onclick="toggleTag(this)">Tr√®s sucr√©</button>
              <button type="button" class="tag-chip" data-section="sucre" data-val="Sucr√©" onclick="toggleTag(this)">Sucr√©</button>
              <button type="button" class="tag-chip" data-section="sucre" data-val="√âquilibr√©" onclick="toggleTag(this)">√âquilibr√©</button>
              <button type="button" class="tag-chip" data-section="sucre" data-val="Peu sucr√©" onclick="toggleTag(this)">Peu sucr√©</button>
              <button type="button" class="tag-chip" data-section="sucre" data-val="Non-sucr√©" onclick="toggleTag(this)">Non-sucr√©</button>
            </div>
          </div>
          <!-- Complexit√© -->
          <div class="tag-section">
            <div class="tag-section-label">Complexit√© <span class="tag-section-limit">0 ou 1</span></div>
            <div class="tag-chips" id="tag-chips-complexite">
              <button type="button" class="tag-chip" data-section="complexite" data-val="Simple" onclick="toggleTag(this)">Simple</button>
              <button type="button" class="tag-chip" data-section="complexite" data-val="Interm√©diaire" onclick="toggleTag(this)">Interm√©diaire</button>
              <button type="button" class="tag-chip" data-section="complexite" data-val="Complexe" onclick="toggleTag(this)">Complexe</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="form-group">
      <label>Ingr√©dients</label>
      <div id="form-ing-list" class="form-ing-list"></div>
      <button class="btn" onclick="addFormIng()" style="margin-top:8px;">+ Ingr√©dient</button>
    </div>
    <div class="form-group">
      <div class="form-section-label">Toppings</div>
      <div id="form-topping-list" class="form-ing-list"></div>
      <button class="btn" onclick="addFormTopping()" style="margin-top:8px;">+ Topping</button>
    </div>
    <div class="form-actions">
      <button class="btn" onclick="cancelEdit()">Annuler</button>
      <button class="btn primary" onclick="saveRecipe()">Enregistrer</button>
    </div>
  </div>

  <div class="section-title">Toutes les recettes</div>
  <div id="manage-recipes-list" class="recipes-list"></div>
</div>

<div class="toast" id="toast"></div>

<!-- LOADING OVERLAY -->
<div id="loading-overlay" style="position:fixed;inset:0;background:rgba(10,9,5,0.92);z-index:2000;display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px;">
  <div style="width:36px;height:36px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;"></div>
  <div style="font-size:0.85rem;letter-spacing:0.25em;text-transform:uppercase;color:var(--text-muted);">Connexion √† GitHub‚Ä¶</div>
</div>

<!-- ERROR OVERLAY -->
<div id="error-overlay" style="position:fixed;inset:0;background:rgba(10,9,5,0.96);z-index:2000;display:none;align-items:center;justify-content:center;">
  <div style="background:var(--surface);border:1px solid var(--red);border-radius:6px;padding:32px;max-width:420px;text-align:center;">
    <div style="font-size:1.5rem;margin-bottom:12px;">‚ö†Ô∏è</div>
    <div id="error-msg" style="font-size:0.95rem;letter-spacing:0.08em;color:var(--text);margin-bottom:20px;line-height:1.6;"></div>
    <button class="btn danger" onclick="document.getElementById('error-overlay').style.display='none';showSetupModal();">Reconfigurer</button>
  </div>
</div>

<!-- SETUP MODAL -->
<div id="setup-modal" style="position:fixed;inset:0;background:rgba(10,9,5,0.96);z-index:2000;display:none;align-items:center;justify-content:center;padding:24px;">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:36px;max-width:480px;width:100%;">
    <div style="font-family:'Cormorant Garamond',serif;font-size:1.8rem;color:var(--gold-light);text-align:center;margin-bottom:6px;letter-spacing:0.08em;">Le Bar</div>
    <div style="font-size:0.82rem;letter-spacing:0.25em;text-transform:uppercase;color:var(--text-muted);text-align:center;margin-bottom:28px;">Configuration GitHub</div>
    <div class="form-group">
      <label>Nom d'utilisateur GitHub</label>
      <input type="text" id="cfg-owner" placeholder="ex: johndoe">
    </div>
    <div class="form-group">
      <label>Nom du repo</label>
      <input type="text" id="cfg-repo" placeholder="ex: mon-bar">
    </div>
    <div class="form-group">
      <label>Personal Access Token</label>
      <input type="password" id="cfg-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
    </div>
    <div style="background:rgba(201,168,76,0.06);border:1px solid var(--border);border-radius:4px;padding:14px;margin-bottom:20px;font-size:0.88rem;line-height:1.7;color:var(--text-muted);">
      Le token est stock√© uniquement dans <strong style="color:var(--text);">localStorage</strong> de ce navigateur. Il ne quitte jamais votre appareil sauf pour les appels √† l'API GitHub.
    </div>
    <button class="btn primary" style="width:100%;" onclick="submitSetup()">Connecter</button>
    <div id="setup-error" style="display:none;margin-top:12px;font-size:0.88rem;color:var(--red);text-align:center;letter-spacing:0.08em;"></div>
  </div>
</div>

<style>@keyframes spin { to { transform: rotate(360deg); } }</style>

<script>
// ‚îÄ‚îÄ‚îÄ GITHUB JSON BACKEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Trois fichiers fixes dans le repo :
//   ingredients.json   ‚Üí { ingredients: [...] }
//   myIngredients.json ‚Üí { myIngredients: [...] }
//   recipes.json       ‚Üí { recipes: [...] }

const FILE_INGS  = 'ingredients.json';
const FILE_INV   = 'myIngredients.json';
const FILE_REC   = 'recipes.json';

let _dbCat = null;  // { ingredients: [...] }
let _dbInv = null;  // { myIngredients: [...] }
let _dbRec = null;  // { recipes: [...] }
let _shaCat = null;
let _shaInv = null;
let _shaRec = null;
let _ghConfig = null; // { owner, repo, token }

const CONFIG_KEY = 'le-bar-gh-config';

// ‚îÄ‚îÄ Configuration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadConfig() {
  try { return JSON.parse(localStorage.getItem(CONFIG_KEY)); } catch { return null; }
}
function saveConfig(cfg) {
  localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
}

// ‚îÄ‚îÄ GitHub API helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function ghRequest(method, endpoint, body) {
  const res = await fetch(`https://api.github.com${endpoint}`, {
    method,
    headers: {
      'Authorization': `token ${_ghConfig.token}`,
      'Content-Type': 'application/json',
      'Accept': 'application/vnd.github.v3+json'
    },
    body: body ? JSON.stringify(body) : undefined
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.message || `GitHub ${res.status}`);
  }
  return res.json();
}

async function ghReadOneFile(filename) {
  const { owner, repo } = _ghConfig;
  const encoded = encodeURIComponent(filename);
  const data = await ghRequest('GET', `/repos/${owner}/${repo}/contents/${encoded}`);
  const content = JSON.parse(decodeURIComponent(escape(atob(data.content.replace(/\n/g, '')))));
  return { content, sha: data.sha };
}

async function ghWriteOneFile(filename, content, sha, message) {
  const { owner, repo } = _ghConfig;
  const encoded = encodeURIComponent(filename);
  const body = {
    message,
    content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
    ...(sha ? { sha } : {})
  };
  const data = await ghRequest('PUT', `/repos/${owner}/${repo}/contents/${encoded}`, body);
  return data.content.sha;
}

// ‚îÄ‚îÄ Initialisation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openDB() {
  _ghConfig = loadConfig();
  if (!_ghConfig) {
    showSetupModal();
    return;
  }
  await loadFromGitHub();
}

async function loadFromGitHub() {
  showLoading(true);
  try {
    // Charger les trois fichiers en parall√®le (tol√©rance si l'un est absent)
    const [rCat, rInv, rRec] = await Promise.allSettled([
      ghReadOneFile(FILE_INGS),
      ghReadOneFile(FILE_INV),
      ghReadOneFile(FILE_REC)
    ]);

    _dbCat = rCat.status === 'fulfilled' ? rCat.value.content : {};
    _shaCat = rCat.status === 'fulfilled' ? rCat.value.sha : null;

    _dbInv = rInv.status === 'fulfilled' ? rInv.value.content : {};
    _shaInv = rInv.status === 'fulfilled' ? rInv.value.sha : null;

    _dbRec = rRec.status === 'fulfilled' ? rRec.value.content : {};
    _shaRec = rRec.status === 'fulfilled' ? rRec.value.sha : null;

    // S'assurer que les stores existent
    if (!_dbCat.ingredients)   _dbCat.ingredients   = [];
    if (!_dbInv.myIngredients) _dbInv.myIngredients = [];
    if (!_dbRec.recipes)       _dbRec.recipes        = [];

    // Normaliser les ids
    _dbCat.ingredients.forEach(i => { if (i.id !== undefined) i.id = parseInt(i.id); });
    _dbInv.myIngredients.forEach(i => { if (i.id !== undefined) i.id = parseInt(i.id); });
    _dbRec.recipes.forEach(i => { if (i.id !== undefined) i.id = parseInt(i.id); });

    // Migration : ingr√©dients par nom ‚Üí par id dans les recettes
    const nameToIdMig = {};
    _dbCat.ingredients.forEach(i => { nameToIdMig[i.name.toLowerCase()] = i.id; });
    let migrated = false;
    _dbRec.recipes.forEach(r => {
      ['ingredients', 'toppings'].forEach(field => {
        if (!r[field]) return;
        r[field].forEach(ing => {
          if (!ing.id && ing.name) {
            const foundId = nameToIdMig[ing.name.toLowerCase()];
            if (foundId) { ing.id = foundId; delete ing.name; migrated = true; }
          }
        });
      });
    });

    showLoading(false);
    if (migrated) await persistRecipes('migration: ingr√©dients r√©f√©renc√©s par id');
    await seedIfEmpty();
    await refreshIngCache();
    renderIngredients();
  } catch (e) {
    showLoading(false);
    showError('Impossible de lire les fichiers GitHub : ' + e.message);
  }
}

// ‚îÄ‚îÄ Persist ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function persistCatalogue(message = 'mise √† jour ingredients.json') {
  _shaCat = await ghWriteOneFile(FILE_INGS, _dbCat, _shaCat, message);
}

async function persistInventaire(message = 'mise √† jour myIngredients.json') {
  _shaInv = await ghWriteOneFile(FILE_INV, _dbInv, _shaInv, message);
}

async function persistRecipes(message = 'mise √† jour recipes.json') {
  _shaRec = await ghWriteOneFile(FILE_REC, _dbRec, _shaRec, message);
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function dbFor(store) {
  if (store === 'recipes')       return _dbRec;
  if (store === 'myIngredients') return _dbInv;
  return _dbCat;
}
async function persistFor(store, message) {
  if (store === 'recipes')       await persistRecipes(message);
  else if (store === 'myIngredients') await persistInventaire(message);
  else await persistCatalogue(message);
}

function nextId(store) {
  const items = dbFor(store)[store];
  if (!items.length) return 1;
  return Math.max(...items.map(i => i.id || 0)) + 1;
}

// ‚îÄ‚îÄ API "tx" ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function txGet(store, key) {
  const k = typeof key === 'string' ? parseInt(key) : key;
  return Promise.resolve(dbFor(store)[store].find(i => i.id === k) || null);
}
function txGetAll(store) {
  return Promise.resolve([...dbFor(store)[store]]);
}
async function txPut(store, val) {
  if (val.id !== undefined) val.id = typeof val.id === 'string' ? parseInt(val.id) : val.id;
  const arr = dbFor(store)[store];
  const idx = arr.findIndex(i => i.id === val.id);
  if (idx >= 0) arr[idx] = val;
  else arr.push(val);
  await persistFor(store, `modif ${store} #${val.id}`);
  return val.id;
}
async function txAdd(store, val) {
  if (store === 'ingredients' && _dbCat.ingredients.find(i => i.name === val.name)) {
    throw new Error('duplicate');
  }
  val.id = nextId(store);
  dbFor(store)[store].push(val);
  await persistFor(store, `ajout ${store} #${val.id}`);
  return val.id;
}
async function txDelete(store, key) {
  const k = typeof key === 'string' ? parseInt(key) : key;
  const db = dbFor(store);
  db[store] = db[store].filter(i => i.id !== k);
  await persistFor(store, `suppression ${store} #${k}`);
}

// ‚îÄ‚îÄ‚îÄ SEED DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function seedIfEmpty() {
  if (_dbCat.ingredients.length > 0) return;

  // Insertion directe en m√©moire (sans commit interm√©diaire)
  const defaultNames = [
    'Vodka', 'Gin', 'Rhum blanc', 'Rhum brun', 'Tequila', 'Triple sec',
    'Vermouth doux', 'Vermouth sec', 'Bourbon', 'Whisky', 'Baileys',
    'Kahl√∫a', 'Amaretto', 'Campari', 'Aperol', 'Midori', 'Cointreau',
    'Jus de citron', 'Jus de lime', "Jus d'orange", "Jus d'ananas",
    'Jus de canneberge', 'Eau tonique', 'Eau gazeuse', 'Ginger beer',
    'Cola', 'Sirop de sucre', "Sirop d'agave", 'Grenadine', 'Angostura bitters',
    'Cr√®me', 'Lait de coco', 'Menthe fra√Æche', 'Citron', 'Lime', 'Orange',
    'Sel', 'Sucre', 'Glace', 'Champagne', 'Prosecco'
  ];
  let ingId = 1;
  for (const name of defaultNames) {
    _dbCat.ingredients.push({ id: ingId++, name });
  }

  // Construire un index name->id depuis les ingr√©dients qu'on vient d'ins√©rer
  const nameToId = {};
  _dbCat.ingredients.forEach(i => { nameToId[i.name] = i.id; });
  function sid(name) { return nameToId[name] || null; }

  const seedRecipes = [
    { name: 'Mojito', ingredients: [
      { id: sid('Rhum blanc'), qty: '60 ml' }, { id: sid('Jus de lime'), qty: '30 ml' },
      { id: sid('Sirop de sucre'), qty: '15 ml' }, { id: sid('Menthe fra\u00eeche'), qty: '8 feuilles' },
      { id: sid('Eau gazeuse'), qty: 'pour compl\u00e9ter' }, { id: sid('Glace'), qty: 'au besoin' }
    ]},
    { name: 'Margarita', ingredients: [
      { id: sid('Tequila'), qty: '50 ml' }, { id: sid('Triple sec'), qty: '20 ml' },
      { id: sid('Jus de lime'), qty: '30 ml' }, { id: sid('Sel'), qty: 'pour le bord' }
    ]},
    { name: 'Cosmopolitan', ingredients: [
      { id: sid('Vodka'), qty: '45 ml' }, { id: sid('Triple sec'), qty: '15 ml' },
      { id: sid('Jus de lime'), qty: '15 ml' }, { id: sid('Jus de canneberge'), qty: '30 ml' }
    ]},
    { name: 'Aperol Spritz', ingredients: [
      { id: sid('Aperol'), qty: '60 ml' }, { id: sid('Prosecco'), qty: '90 ml' },
      { id: sid('Eau gazeuse'), qty: '30 ml' }, { id: sid('Orange'), qty: '1 tranche' }
    ]},
    { name: 'Old Fashioned', ingredients: [
      { id: sid('Bourbon'), qty: '60 ml' }, { id: sid('Sirop de sucre'), qty: '5 ml' },
      { id: sid('Angostura bitters'), qty: '2 traits' }, { id: sid('Orange'), qty: '1 zeste' }
    ]},
    { name: 'Gin Tonic', ingredients: [
      { id: sid('Gin'), qty: '50 ml' }, { id: sid('Eau tonique'), qty: '150 ml' },
      { id: sid('Lime'), qty: '1 quartier' }, { id: sid('Glace'), qty: 'au besoin' }
    ]},
    { name: 'Moscow Mule', ingredients: [
      { id: sid('Vodka'), qty: '50 ml' }, { id: sid('Ginger beer'), qty: '120 ml' },
      { id: sid('Jus de lime'), qty: '15 ml' }, { id: sid('Menthe fra\u00eeche'), qty: 'quelques feuilles' }
    ]},
    { name: 'Daiquiri', ingredients: [
      { id: sid('Rhum blanc'), qty: '60 ml' }, { id: sid('Jus de lime'), qty: '30 ml' },
      { id: sid('Sirop de sucre'), qty: '15 ml' }
    ]},
    { name: 'Negroni', ingredients: [
      { id: sid('Gin'), qty: '30 ml' }, { id: sid('Vermouth doux'), qty: '30 ml' },
      { id: sid('Campari'), qty: '30 ml' }, { id: sid('Orange'), qty: '1 zeste' }
    ]},
    { name: 'Pi\u00f1a Colada', ingredients: [
      { id: sid('Rhum blanc'), qty: '60 ml' }, { id: sid('Lait de coco'), qty: '60 ml' },
      { id: sid("Jus d'ananas"), qty: '90 ml' }, { id: sid('Glace'), qty: 'au besoin' }
    ]}
  ];
  let recId = 1;
  for (const r of seedRecipes) {
    _dbRec.recipes.push({ id: recId++, ...r, toppings: [], glass: '', rating: 0, notes: '' });
  }

  // Commit les trois fichiers en parall√®le
  await Promise.all([
    persistCatalogue('initialisation ingredients par d√©faut'),
    persistRecipes('initialisation recettes par d√©faut')
  ]);
}

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let filterActive = false;
let _cachedIngs = []; // cache global pour l'autocomplete [{id, name}]

async function refreshIngCache() {
  const all = await txGetAll('ingredients');
  _cachedIngs = all.map(i => ({ id: i.id, name: i.name }));
}

// ‚îÄ‚îÄ‚îÄ GLASS ICONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GLASS_LABELS = {
  shooter: 'Shooter', highball: 'Highball', lowball: 'Verre bas',
  coupe: 'Coupe', martini: 'Martini', hurricane: 'Hurricane',
  flute: 'Fl√ªte', mug: 'Mug', autre: 'Autre'
};

// Simple SVG paths for each glass silhouette
const GLASS_SVG = {
  shooter: `<svg viewBox="0 0 20 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 2h8l-1.5 18h-5L6 2z" stroke="currentColor" stroke-width="1.2" fill="none"/></svg>`,
  highball: `<svg viewBox="0 0 20 24" xmlns="http://www.w3.org/2000/svg"><path d="M5 2h10l-1.2 20H6.2L5 2z" stroke="currentColor" stroke-width="1.2" fill="none"/></svg>`,
  lowball: `<svg viewBox="0 0 24 20" xmlns="http://www.w3.org/2000/svg"><path d="M4 3h16l-2 14H6L4 3z" stroke="currentColor" stroke-width="1.2" fill="none"/></svg>`,
  coupe: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 4 Q4 16 12 16 Q20 16 20 4 Z" stroke="currentColor" stroke-width="1.2" fill="none"/><line x1="12" y1="16" x2="12" y2="22" stroke="currentColor" stroke-width="1.2"/><line x1="8" y1="22" x2="16" y2="22" stroke="currentColor" stroke-width="1.2"/></svg>`,
  martini: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 3 L12 15 L21 3 Z" stroke="currentColor" stroke-width="1.2" fill="none"/><line x1="12" y1="15" x2="12" y2="22" stroke="currentColor" stroke-width="1.2"/><line x1="8" y1="22" x2="16" y2="22" stroke="currentColor" stroke-width="1.2"/></svg>`,
  hurricane: `<svg viewBox="0 0 24 28" xmlns="http://www.w3.org/2000/svg"><path d="M8 2 Q2 8 3 14 Q4 20 6 24 Q9 28 12 28 Q15 28 18 24 Q20 20 21 14 Q22 8 16 2 Z" stroke="currentColor" stroke-width="1.2" fill="none"/></svg>`,
  flute: `<svg viewBox="0 0 16 28" xmlns="http://www.w3.org/2000/svg"><path d="M4 2 Q3 12 5 20 L5 26" stroke="currentColor" stroke-width="1.2" fill="none"/><path d="M12 2 Q13 12 11 20 L11 26" stroke="currentColor" stroke-width="1.2" fill="none"/><line x1="5" y1="26" x2="11" y2="26" stroke="currentColor" stroke-width="1.2"/><path d="M4 2 Q8 5 12 2" stroke="currentColor" stroke-width="1.2" fill="none"/></svg>`,
  mug: `<svg viewBox="0 0 24 22" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="14" height="17" rx="2" stroke="currentColor" stroke-width="1.2" fill="none"/><path d="M17 8 Q22 8 22 12 Q22 16 17 16" stroke="currentColor" stroke-width="1.2" fill="none"/></svg>`,
  autre: `<svg viewBox="0 0 20 24" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="2" width="12" height="20" rx="3" stroke="currentColor" stroke-width="1.2" fill="none"/></svg>`
};

function glassIcon(type) {
  if (!type || !GLASS_SVG[type]) return '';
  return `<span class="glass-icon" title="${GLASS_LABELS[type] || type}">${GLASS_SVG[type]}</span>`;
}

function starsDisplay(rating) {
  if (!rating) return '';
  let html = '<span class="stars-display">';
  for (let i = 1; i <= 5; i++) html += `<span class="star ${i <= rating ? 'on' : ''}">‚òÖ</span>`;
  html += '</span>';
  return html;
}

function setRating(val) {
  document.getElementById('recipe-rating').value = val;
  document.querySelectorAll('#rating-input .star-btn[data-val]').forEach(btn => {
    btn.classList.toggle('on', parseInt(btn.dataset.val) <= val);
  });
}

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showTab(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  const idx = ['ingredients','recipes','manage'].indexOf(name);
  document.querySelectorAll('.tab-btn')[idx].classList.add('active');
  if (name === 'ingredients') renderIngredients();
  if (name === 'recipes') renderRecipes();
  if (name === 'manage') { renderManageList(); if (!document.getElementById('edit-id').value) renderFormIngs([]); }
}

// ‚îÄ‚îÄ‚îÄ INGREDIENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderIngredients() {
  const filter = document.getElementById('ing-filter').value.toLowerCase();
  const [allIngs, myIngs] = await Promise.all([txGetAll('ingredients'), txGetAll('myIngredients')]);
  const mySet = new Set(myIngs.map(i => typeof i.id === 'string' ? parseInt(i.id) : i.id));
  const grid = document.getElementById('ingredients-grid');
  const filtered = allIngs.filter(i => i.name.toLowerCase().includes(filter));
  filtered.sort((a,b) => a.name.localeCompare(b.name));
  if (!filtered.length) {
    grid.innerHTML = '<div class="empty"><div class="icon">üîç</div><p>Aucun ingr√©dient trouv√©</p></div>';
    return;
  }
  grid.innerHTML = filtered.map(i => `
    <div class="ingredient-item ${mySet.has(i.id) ? 'checked' : ''}" onclick="toggleIng(${i.id}, this)" id="ing-item-${i.id}">
      <div class="check"></div>
      <span class="name">${i.name}</span>
      <button class="edit-ing" onclick="event.stopPropagation();startEditIng(${i.id})" title="Renommer">‚úé</button>
      <button class="del-ing" onclick="event.stopPropagation();deleteIng(${i.id})" title="Supprimer">√ó</button>
    </div>
  `).join('');
}

async function toggleIng(id, el) {
  const has = await txGet('myIngredients', id);
  if (has) { await txDelete('myIngredients', id); el.classList.remove('checked'); }
  else { await txPut('myIngredients', { id }); el.classList.add('checked'); }
  await refreshInventory();
}

async function addIngredient() {
  const input = document.getElementById('new-ing-name');
  const name = input.value.trim();
  if (!name) return;
  try {
    await txAdd('ingredients', { name });
    input.value = '';
    await refreshIngCache();
    renderIngredients();
    toast('Ingr√©dient ajout√©');
  } catch(e) { toast('Cet ingr√©dient existe d√©j√†'); }
}

async function deleteIng(id) {
  if (!confirm('Supprimer cet ingr√©dient ?')) return;
  await txDelete('ingredients', id);
  await txDelete('myIngredients', id);
  await refreshIngCache();
  renderIngredients();
  toast('Ingr√©dient supprim√©');
}

function startEditIng(id) {
  const item = document.getElementById('ing-item-' + id);
  if (!item) return;
  const nameEl = item.querySelector('.name');
  const currentName = nameEl.textContent;
  // Remplacer le span par un input inline
  item.querySelector('.edit-ing').style.display = 'none';
  item.querySelector('.del-ing').style.display = 'none';
  item.style.pointerEvents = 'none'; // bloquer le toggle pendant l'√©dition
  const input = document.createElement('input');
  input.className = 'ing-edit-input';
  input.value = currentName;
  nameEl.replaceWith(input);
  input.focus();
  input.select();
  const confirm_ = async () => {
    const newName = input.value.trim();
    if (newName && newName !== currentName) {
      await renameIng(id, newName);
    } else {
      renderIngredients();
    }
  };
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') confirm_();
    if (e.key === 'Escape') renderIngredients();
    e.stopPropagation();
  });
  input.addEventListener('blur', confirm_);
}

async function renameIng(id, newName) {
  // V√©rifier unicit√©
  const all = await txGetAll('ingredients');
  if (all.find(i => i.id !== id && i.name.toLowerCase() === newName.toLowerCase())) {
    toast('Ce nom existe d√©j√†');
    renderIngredients();
    return;
  }
  const ing = await txGet('ingredients', id);
  if (!ing) return;
  await txPut('ingredients', { ...ing, name: newName });
  await refreshIngCache();
  renderIngredients();
  toast('Ingr√©dient renomm√©');
}

// ‚îÄ‚îÄ‚îÄ RECIPES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _activeGlass   = '';
let _activeIngId   = null;  // id de l'ingr√©dient filtr√©
let _minRating     = 0;
let _activeFilterTags = new Set(); // tags actifs dans le filtre
let filterFavorites = false;

// ‚îÄ‚îÄ‚îÄ FAVOURITES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function toggleFavorite(id, event) {
  event.stopPropagation();
  const recipes = _dbRec.recipes;
  const r = recipes.find(r => r.id === id);
  if (!r) return;
  r.favorite = !r.favorite;
  await persistRecipes('favori recette #' + id);
  renderRecipes();
}

// ‚îÄ‚îÄ‚îÄ TAG PANEL (formulaire) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TAG_LIMITS = { profil: 3, texture: 1, sucre: 1, complexite: 1 };
let _formTags = { profil: [], texture: [], sucre: [], complexite: [] };

function toggleTagPanel() {
  const panel = document.getElementById('form-tag-panel');
  const isOpen = panel.style.display !== 'none';
  panel.style.display = isOpen ? 'none' : 'block';
}

document.addEventListener('click', e => {
  if (!e.target.closest('#form-tag-wrap')) {
    const p = document.getElementById('form-tag-panel');
    if (p) p.style.display = 'none';
  }
});

function toggleTag(btn) {
  const section = btn.dataset.section;
  const val = btn.dataset.val;
  const limit = TAG_LIMITS[section] || 1;
  const arr = _formTags[section];
  const isActive = arr.includes(val);

  if (isActive) {
    // Toujours permettre la d√©s√©lection
    _formTags[section] = arr.filter(v => v !== val);
  } else {
    // Seulement ajouter si la limite n'est pas atteinte
    if (arr.length < limit) {
      _formTags[section] = [...arr, val];
    }
    // Si limite atteinte, on ne fait rien (le chip reste disabled)
  }
  updateTagBtnUI();
  updateTagChipStates();
}

function updateTagBtnUI() {
  const total = Object.values(_formTags).flat().length;
  const btn = document.getElementById('form-tag-toggle-btn');
  const badge = document.getElementById('form-tag-count');
  const label = document.getElementById('form-tag-btn-label');
  if (total > 0) {
    btn.classList.add('has-tags');
    badge.style.display = '';
    badge.textContent = total;
    label.textContent = 'Tags s√©lectionn√©s';
  } else {
    btn.classList.remove('has-tags');
    badge.style.display = 'none';
    label.textContent = 'Ajouter des tags';
  }
}

function updateTagChipStates() {
  // dim chips that are at limit
  Object.keys(TAG_LIMITS).forEach(section => {
    const limit = TAG_LIMITS[section];
    const arr = _formTags[section];
    document.querySelectorAll(`#tag-chips-${section} .tag-chip`).forEach(chip => {
      const isActive = arr.includes(chip.dataset.val);
      chip.classList.toggle('active', isActive);
      chip.classList.toggle('disabled', !isActive && arr.length >= limit);
    });
  });
}

function resetFormTags() {
  _formTags = { profil: [], texture: [], sucre: [], complexite: [] };
  document.querySelectorAll('.tag-chip').forEach(c => { c.classList.remove('active', 'disabled'); });
  updateTagBtnUI();
}

function loadTagsIntoForm(tags) {
  resetFormTags();
  if (!tags) return;
  Object.keys(tags).forEach(section => {
    if (!_formTags[section]) return;
    (tags[section] || []).forEach(val => {
      _formTags[section].push(val);
      const btn = document.querySelector(`#tag-chips-${section} .tag-chip[data-val="${CSS.escape(val)}"]`);
      if (btn) btn.classList.add('active');
    });
  });
  updateTagBtnUI();
  updateTagChipStates();
}

// ‚îÄ‚îÄ‚îÄ TAG FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleFilterTag(btn) {
  const tag = btn.dataset.tag;
  if (_activeFilterTags.has(tag)) {
    _activeFilterTags.delete(tag);
    btn.classList.remove('active');
  } else {
    _activeFilterTags.add(tag);
    btn.classList.add('active');
  }
  const count = _activeFilterTags.size;
  const fval = document.getElementById('fval-tags');
  if (count === 0) { fval.textContent = 'Tous'; fval.classList.add('unset'); }
  else { fval.textContent = count + ' tag' + (count > 1 ? 's' : ''); fval.classList.remove('unset'); }
  updateFilterBadge();
  renderRecipes();
}

function resetTagFilters() {
  _activeFilterTags.clear();
  document.querySelectorAll('[id^="ftags-"] .filter-chip').forEach(c => c.classList.remove('active'));
  const fval = document.getElementById('fval-tags');
  fval.textContent = 'Tous'; fval.classList.add('unset');
}

// helper: all tags of a recipe as flat array
function recipeAllTags(r) {
  if (!r.tags) return [];
  return Object.values(r.tags).flat();
}

// render tag pills for a recipe
function renderTagPills(r, cardPrefix) {
  if (!r.tags) return '';
  const SECTION_CLASS = { profil: 'profil', texture: 'texture', sucre: 'sucre', complexite: 'complexite' };
  const pills = [];
  Object.entries(r.tags).forEach(([sec, vals]) => {
    (vals || []).forEach(v => {
      pills.push(`<span class="recipe-tag-pill ${SECTION_CLASS[sec] || ''}">${v}</span>`);
    });
  });
  const toggleFn = cardPrefix === 'mr' ? `toggleMCard(${r.id})` : `toggleCard(${r.id})`;
  return pills.length ? `<div class="recipe-tags" onclick="${toggleFn}" style="cursor:pointer;">${pills.join('')}</div>` : '';
}

function toggleFilterPanel() {
  const panel = document.getElementById('filter-panel');
  const isOpen = panel.style.display !== 'none';
  panel.style.display = isOpen ? 'none' : 'block';
}

document.addEventListener('click', e => {
  if (!e.target.closest('.filter-btn-wrap')) {
    const panel = document.getElementById('filter-panel');
    if (panel) panel.style.display = 'none';
  }
  if (!e.target.closest('.fing-search-wrap')) {
    const dd = document.getElementById('fing-dropdown');
    if (dd) dd.style.display = 'none';
  }
});

// ‚îÄ‚îÄ Ouvrir/fermer une sous-section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleFSection(id) {
  const sec = document.getElementById(id);
  const key = id.replace('fsec-', '');
  const arr = document.getElementById('farr-' + key);
  const isOpen = sec.style.display !== 'none';
  sec.style.display = isOpen ? 'none' : 'block';
  arr.classList.toggle('open', !isOpen);
  // Peupler l'autocomplete ingr√©dient √† l'ouverture
  if (!isOpen && key === 'ing') {
    document.getElementById('fing-input').value = '';
    document.getElementById('fing-dropdown').style.display = 'none';
  }
}

// ‚îÄ‚îÄ Verre ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectGlass(btn) {
  document.querySelectorAll('#glass-chips .filter-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  _activeGlass = btn.dataset.val;
  const valEl = document.getElementById('fval-glass');
  valEl.textContent = btn.dataset.val ? btn.textContent.trim() : 'Tous';
  valEl.classList.toggle('unset', !btn.dataset.val);
  updateFilterBadge();
  renderRecipes();
}

// ‚îÄ‚îÄ Ingr√©dient autocomplete ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showFilterIngAC(input) {
  const val = input.value.toLowerCase().trim();
  const dd = document.getElementById('fing-dropdown');
  const matches = val
    ? _cachedIngs.filter(i => i.name.toLowerCase().includes(val)).slice(0, 10)
    : _cachedIngs.slice().sort((a,b) => a.name.localeCompare(b.name)).slice(0, 12);
  if (!matches.length) { dd.style.display = 'none'; return; }
  dd.innerHTML = matches.map(i => {
    let label = i.name;
    if (val) {
      const idx = i.name.toLowerCase().indexOf(val);
      if (idx >= 0) label = i.name.slice(0,idx) + `<strong style="color:var(--gold-light)">${i.name.slice(idx, idx+val.length)}</strong>` + i.name.slice(idx+val.length);
    }
    return `<div onmousedown="selectFilterIng(${i.id}, '${i.name.replace(/'/g,"\\'")}')">${label}</div>`;
  }).join('');
  dd.style.display = 'block';
}

function selectFilterIng(id, name) {
  _activeIngId = id;
  document.getElementById('fing-input').value = '';
  document.getElementById('fing-dropdown').style.display = 'none';
  document.getElementById('fing-active-name').textContent = name;
  document.getElementById('fing-active-tag').style.display = 'flex';
  const valEl = document.getElementById('fval-ing');
  valEl.textContent = name;
  valEl.classList.remove('unset');
  updateFilterBadge();
  renderRecipes();
}

function clearIngFilter() {
  _activeIngId = null;
  document.getElementById('fing-active-tag').style.display = 'none';
  document.getElementById('fing-active-name').textContent = '';
  const valEl = document.getElementById('fval-ing');
  valEl.textContent = 'Tous';
  valEl.classList.add('unset');
  updateFilterBadge();
  renderRecipes();
}

// ‚îÄ‚îÄ Note minimale (√©toiles) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectFilterRating(val) {
  _minRating = val;
  // Mettre √† jour l'affichage des √©toiles (r√©utilise la logique de setRating)
  document.querySelectorAll('#frating-stars .star-btn[data-val]').forEach(btn => {
    btn.classList.toggle('on', parseInt(btn.dataset.val) <= val);
  });
  const valEl = document.getElementById('fval-rating');
  valEl.textContent = val ? '‚â• ' + '‚òÖ'.repeat(val) : 'Toutes';
  valEl.classList.toggle('unset', !val);
  updateFilterBadge();
  renderRecipes();
}

// ‚îÄ‚îÄ Shake ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let filterShake = ''; // '' | 'yes' | 'no'

function selectShake(btn) {
  document.querySelectorAll('#fsec-shake .filter-chip').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  filterShake = btn.dataset.val;
  const valEl = document.getElementById('fval-shake');
  const labels = { '': 'Peu importe', 'yes': 'Requis', 'no': 'Non requis' };
  valEl.textContent = labels[filterShake];
  valEl.classList.toggle('unset', !filterShake);
  updateFilterBadge();
  renderRecipes();
}

// ‚îÄ‚îÄ Booleans (makeable seulement d√©sormais) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleFilterChip(btn, type) {
  if (type === 'favorites') {
    filterFavorites = !filterFavorites;
    btn.classList.toggle('active', filterFavorites);
    updateFilterBadge();
    renderRecipes();
  } else if (type === 'makeable') {
    filterActive = !filterActive;
    btn.classList.toggle('active', filterActive);
    updateFilterBadge();
    renderRecipes();
  }
}

// ‚îÄ‚îÄ Reset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resetFilters() {
  _activeGlass = '';
  _activeIngId = null;
  _minRating = 0;
  filterActive = false;
  filterShake = false;
  filterFavorites = false;

  document.getElementById('chip-favorites').classList.remove('active');
  document.getElementById('chip-makeable').classList.remove('active');
  document.querySelectorAll('#glass-chips .filter-chip').forEach(c => c.classList.remove('active'));
  document.querySelector('#glass-chips .filter-chip[data-val=""]').classList.add('active');
  document.getElementById('fval-glass').textContent = 'Tous';
  document.getElementById('fval-glass').classList.add('unset');

  document.getElementById('fing-active-tag').style.display = 'none';
  document.getElementById('fval-ing').textContent = 'Tous';
  document.getElementById('fval-ing').classList.add('unset');

  document.querySelectorAll('#frating-stars .star-btn[data-val]').forEach(btn => btn.classList.remove('on'));
  document.getElementById('fval-rating').textContent = 'Toutes';
  document.getElementById('fval-rating').classList.add('unset');

  filterShake = '';
  document.querySelectorAll('#fsec-shake .filter-chip').forEach(c => c.classList.remove('active'));
  document.querySelector('#fsec-shake .filter-chip[data-val=""]').classList.add('active');
  document.getElementById('fval-shake').textContent = 'Peu importe';
  document.getElementById('fval-shake').classList.add('unset');

  resetTagFilters();

  updateFilterBadge();
  renderRecipes();
}

// ‚îÄ‚îÄ Badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateFilterBadge() {
  const count = (_activeGlass ? 1 : 0) + (_activeIngId ? 1 : 0) + (_minRating ? 1 : 0) + (filterActive ? 1 : 0) + (filterShake ? 1 : 0) + (_activeFilterTags.size > 0 ? 1 : 0) + (filterFavorites ? 1 : 0);
  const badge = document.getElementById('filter-count-badge');
  const btn   = document.getElementById('filter-main-btn');
  if (count > 0) {
    badge.textContent = count;
    badge.style.display = 'inline-block';
    btn.classList.add('has-filters');
  } else {
    badge.style.display = 'none';
    btn.classList.remove('has-filters');
  }
}

// ‚îÄ‚îÄ‚îÄ INVENTORY STATE (global, recalcul√© √† chaque changement) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _mySet = new Set();
let _ingMap = {};     // id -> name
let _ingNameMap = {}; // name (lowercase) -> id (legacy fallback)

async function refreshInventory() {
  const [allIngs, myIngs] = await Promise.all([txGetAll('ingredients'), txGetAll('myIngredients')]);
  _ingMap = {}; // id -> name
  _ingNameMap = {}; // name (lowercase) -> id  (legacy fallback)
  allIngs.forEach(i => {
    _ingMap[i.id] = i.name;
    _ingNameMap[i.name.toLowerCase()] = i.id;
  });
  _mySet = new Set(myIngs.map(i => i.id));
}

function resolveIngId(ing) {
  // Pr√©f√©rer l'id stock√©, sinon fallback par nom
  if (ing.id) return ing.id;
  if (ing.name) return _ingNameMap[ing.name.toLowerCase()];
  return null;
}
function resolveIngName(ing) {
  if (ing.id && _ingMap[ing.id]) return _ingMap[ing.id];
  return ing.name || '?';
}

function isMakeable(r) {
  const ingOk = r.ingredients.every(ing => {
    if (ing.optional) return true;
    const id = resolveIngId(ing);
    return id && _mySet.has(id);
  });
  const toppingOk = (r.toppings || []).every(t => {
    if (t.optional) return true;
    const id = resolveIngId(t);
    return id && _mySet.has(id);
  });
  return ingOk && toppingOk;
}

async function renderRecipes() {
  await refreshInventory();
  const filter = document.getElementById('recipe-filter').value.toLowerCase();
  const recipes = await txGetAll('recipes');

  let filtered = recipes.filter(r => r.name.toLowerCase().includes(filter));
  if (_activeGlass)  filtered = filtered.filter(r => r.glass === _activeGlass);
  if (_minRating)    filtered = filtered.filter(r => (r.rating || 0) >= _minRating);
  if (_activeIngId)  filtered = filtered.filter(r =>
    [...(r.ingredients || []), ...(r.toppings || [])].some(i => resolveIngId(i) === _activeIngId)
  );
  if (filterShake === 'yes')  filtered = filtered.filter(r => r.ingredients.some(i => i.shake));
  if (filterShake === 'no')   filtered = filtered.filter(r => !r.ingredients.some(i => i.shake));
  if (_activeFilterTags.size > 0) {
    filtered = filtered.filter(r => {
      const allTags = recipeAllTags(r);
      return [..._activeFilterTags].every(t => allTags.includes(t));
    });
  }
  if (filterActive) filtered = filtered.filter(isMakeable);
  if (filterFavorites) filtered = filtered.filter(r => r.favorite);

  // Trier : favoris en premier, puis alphab√©tique
  filtered.sort((a, b) => {
    if (!!b.favorite !== !!a.favorite) return b.favorite ? 1 : -1;
    return a.name.localeCompare(b.name);
  });

  const list = document.getElementById('recipes-list');
  if (!filtered.length) {
    const hasFilter = filterActive || filterFavorites || _activeGlass || _activeIngId || _minRating || filterShake || _activeFilterTags.size > 0;
    list.innerHTML = '<div class="empty"><div class="icon">üçπ</div><p>' + (hasFilter ? 'Aucune recette correspond aux filtres' : 'Aucune recette') + '</p></div>';
    return;
  }

  list.innerHTML = filtered.map(r => {
    const makeable = isMakeable(r);
    const metaItems = [];
    if (r.glass) metaItems.push(`<span style="display:flex;align-items:center;gap:5px;color:var(--text-muted);font-size:0.7rem;letter-spacing:0.1em;">${glassIcon(r.glass)}<span>${GLASS_LABELS[r.glass]||r.glass}</span></span>`);
    if (r.rating) metaItems.push(starsDisplay(r.rating));

    const ingRows = r.ingredients.map(ing => {
      const id = resolveIngId(ing);
      const have = id && _mySet.has(id);
      const displayName = resolveIngName(ing);
      const flags = [
        ing.shake ? `<span class="flag-pill flag-shake">Shake</span>` : '',
        ing.optional ? `<span class="flag-pill flag-optional">Facultatif</span>` : ''
      ].filter(Boolean).join('');
      return `<div class="ing-row ${!have ? 'missing-ing' : ''}">
        <span class="ing-name">${displayName}${flags ? `<span class="ing-flags">${flags}</span>` : ''}</span>
        <span class="ing-qty">${ing.qty}</span>
      </div>`;
    }).join('');

    const toppingRows = (r.toppings && r.toppings.length) ? `
      <div class="topping-divider">Toppings</div>
      ${r.toppings.map(t => { const tid = resolveIngId(t); const thave = tid && _mySet.has(tid); const dn = resolveIngName(t); const f = t.optional ? `<span class="ing-flags"><span class="flag-pill flag-optional">Facultatif</span></span>` : ''; return `<div class="ing-row ${!thave ? 'missing-ing' : ''}"><span class="ing-name">${dn}${f}</span><span class="ing-qty">${t.qty}</span></div>`; }).join('')}` : '';

    const missingIngs = [...(r.ingredients || []), ...(r.toppings || [])].filter(ing => {
      if (ing.optional) return false;
      const id = resolveIngId(ing);
      return !(id && _mySet.has(id));
    });
    const badgeLabel = makeable
      ? '‚úì R√©alisable'
      : missingIngs.length === 1
        ? `Manque : ${resolveIngName(missingIngs[0])}`
        : 'Manque des ingr√©dients';

    return `
      <div class="recipe-card ${makeable ? 'makeable' : ''}" id="rc-${r.id}">
        <div class="recipe-header" onclick="toggleCard(${r.id})">
          <button class="fav-btn ${r.favorite ? 'on' : ''}" onclick="toggleFavorite(${r.id}, event)" title="${r.favorite ? 'Retirer des favoris' : 'Ajouter aux favoris'}">‚òÖ</button>
          <span class="rname">${r.name}</span>
          ${metaItems.length ? '<span class="recipe-meta-wrap" style="display:flex;align-items:center;gap:10px;">' + metaItems.join('') + '</span>' : ''}
          <span class="badge ${makeable ? 'ok' : 'missing'}">${badgeLabel}</span>
          <span class="arrow">‚ñº</span>
        </div>
        ${renderTagPills(r, 'rc')}
        <div class="recipe-body">
          <div class="ingredients-list">
            ${ingRows}
            ${toppingRows}
          </div>
          ${r.notes ? `<div class="recipe-notes-section"><div class="recipe-notes-label">Notes</div><div class="recipe-notes-text">${r.notes.replace(/</g,'&lt;')}</div></div>` : ''}
          <div class="recipe-actions">
            <button class="btn" onclick="editRecipe(${r.id})">Modifier</button>
          </div>
        </div>
      </div>`;
  }).join('');
}

function toggleCard(id) {
  document.getElementById('rc-'+id).classList.toggle('open');
}

// ‚îÄ‚îÄ‚îÄ MANAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderManageList() {
  await refreshInventory();
  const recipes = await txGetAll('recipes');
  recipes.sort((a,b) => a.name.localeCompare(b.name));
  const list = document.getElementById('manage-recipes-list');
  if (!recipes.length) { list.innerHTML = '<div class="empty"><div class="icon">üç∏</div><p>Aucune recette enregistr√©e</p></div>'; return; }
  list.innerHTML = recipes.map(r => {
    const ingRows = r.ingredients.map(ing => {
      const displayName = resolveIngName(ing);
      const flags = [
        ing.shake ? `<span class="flag-pill flag-shake">Shake</span>` : '',
        ing.optional ? `<span class="flag-pill flag-optional">Facultatif</span>` : ''
      ].filter(Boolean).join('');
      return `<div class="ing-row">
        <span class="ing-name">${displayName}${flags ? `<span class="ing-flags">${flags}</span>` : ''}</span>
        <span class="ing-qty">${ing.qty}</span>
      </div>`;
    }).join('');
    const toppingRows = (r.toppings && r.toppings.length) ? `
      <div class="topping-divider">Toppings</div>
      ${r.toppings.map(t => { const dn = resolveIngName(t); const f = t.optional ? `<span class="ing-flags"><span class="flag-pill flag-optional">Facultatif</span></span>` : ''; return `<div class="ing-row"><span class="ing-name">${dn}${f}</span><span class="ing-qty">${t.qty}</span></div>`; }).join('')}` : '';
    return `
    <div class="recipe-card" id="mr-${r.id}">
      <div class="recipe-header" onclick="toggleMCard(${r.id})">
        <span class="rname">${r.name}</span>
        <span style="display:flex;align-items:center;gap:8px;">
          ${r.glass ? glassIcon(r.glass) : ''}
          ${r.rating ? starsDisplay(r.rating) : ''}
        </span>
        <span style="font-size:0.65rem;letter-spacing:0.1em;color:var(--text-muted)">${r.ingredients.length} ingr√©dient${r.ingredients.length !== 1 ? 's' : ''}</span>
        <span class="arrow">‚ñº</span>
      </div>
      ${renderTagPills(r, 'mr')}
      <div class="recipe-body">
        <div class="ingredients-list">
          ${ingRows}
          ${toppingRows}
        </div>
        ${r.notes ? `<div class="recipe-notes-section"><div class="recipe-notes-label">Notes</div><div class="recipe-notes-text">${r.notes.replace(/</g,'&lt;')}</div></div>` : ''}
        <div class="recipe-actions">
          <button class="btn danger" onclick="deleteRecipe(${r.id})">Supprimer</button>
          <button class="btn" onclick="editRecipe(${r.id})">Modifier</button>
        </div>
      </div>
    </div>`}).join('');
}

function toggleMCard(id) {
  document.getElementById('mr-'+id).classList.toggle('open');
}

function startNew() {
  document.getElementById('edit-id').value = '';
  document.getElementById('recipe-name').value = '';
  document.getElementById('recipe-glass').value = '';
  document.getElementById('recipe-notes').value = '';
  document.getElementById('form-title').textContent = 'Nouvelle recette';
  setRating(0);
  resetFormTags();
  renderFormIngs([], []);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function cancelEdit() {
  startNew();
}

function renderFormIngs(ings, toppings) {
  const list = document.getElementById('form-ing-list');
  const tlist = document.getElementById('form-topping-list');
  list.innerHTML = '';
  tlist.innerHTML = '';
  if (!ings || !ings.length) addFormIng();
  else ings.forEach(ing => addFormIng(ing));
  if (toppings && toppings.length) toppings.forEach(t => addFormTopping(t));
}

async function addFormIng(preset = null) {
  await refreshIngCache();
  const list = document.getElementById('form-ing-list');
  const row = document.createElement('div');
  row.className = 'form-ing-row';
  const shake = preset && preset.shake ? 'active-shake' : '';
  const optional = preset && preset.optional ? 'active-optional' : '';
  row.innerHTML = `
    <div class="autocomplete-wrapper">
      <input type="text" placeholder="Ingr√©dient" class="ing-input" autocomplete="off"
        oninput="showAC(this)" onfocus="showAC(this)">
      <input type="hidden" class="ing-id-input">
      <div class="autocomplete-dropdown" style="display:none"></div>
    </div>
    <input type="text" placeholder="Quantit\u00e9" class="qty-input">
    <button type="button" class="ing-pill-toggle ${shake}" title="\u00c0 shaker" onclick="this.classList.toggle('active-shake')">Shake</button>
    <button type="button" class="ing-pill-toggle ${optional}" title="Facultatif" onclick="this.classList.toggle('active-optional')">Facultatif</button>
    <button class="remove-ing" onclick="this.closest('.form-ing-row').remove()">\u00d7</button>
  `;
  list.appendChild(row);
  if (preset) {
    const ing = preset.id
      ? _cachedIngs.find(i => i.id === preset.id)
      : _cachedIngs.find(i => i.name === preset.name);
    if (ing) {
      row.querySelector('.ing-input').value = ing.name;
      row.querySelector('.ing-id-input').value = ing.id;
    } else if (preset.name) {
      row.querySelector('.ing-input').value = preset.name;
    }
    row.querySelector('.qty-input').value = preset.qty || '';
  }
}

async function addFormTopping(preset = null) {
  await refreshIngCache();
  const list = document.getElementById('form-topping-list');
  const row = document.createElement('div');
  row.className = 'form-ing-row';
  const optional = preset && preset.optional ? 'active-optional' : '';
  row.innerHTML = `
    <div class="autocomplete-wrapper">
      <input type="text" placeholder="Topping" class="ing-input" autocomplete="off"
        oninput="showAC(this)" onfocus="showAC(this)">
      <input type="hidden" class="ing-id-input">
      <div class="autocomplete-dropdown" style="display:none"></div>
    </div>
    <input type="text" placeholder="Quantit\u00e9" class="qty-input">
    <button type="button" class="ing-pill-toggle ${optional}" title="Facultatif" onclick="this.classList.toggle('active-optional')">Facultatif</button>
    <button class="remove-ing" onclick="this.closest('.form-ing-row').remove()">\u00d7</button>
  `;
  list.appendChild(row);
  if (preset) {
    const ing = preset.id
      ? _cachedIngs.find(i => i.id === preset.id)
      : _cachedIngs.find(i => i.name === preset.name);
    if (ing) {
      row.querySelector('.ing-input').value = ing.name;
      row.querySelector('.ing-id-input').value = ing.id;
    } else if (preset.name) {
      row.querySelector('.ing-input').value = preset.name;
    }
    row.querySelector('.qty-input').value = preset.qty || '';
  }
}

function showAC(input) {
  const val = input.value.toLowerCase().trim();
  const dropdown = input.parentElement.querySelector('.autocomplete-dropdown');
  const ings = _cachedIngs;
  const matches = val
    ? ings.filter(i => i.name.toLowerCase().includes(val)).slice(0, 10)
    : ings.slice().sort((a,b) => a.name.localeCompare(b.name)).slice(0, 14);
  if (!matches.length) { dropdown.style.display = 'none'; return; }
  dropdown.innerHTML = matches.map(i => {
    let label = i.name;
    if (val) {
      const idx = i.name.toLowerCase().indexOf(val);
      if (idx >= 0) label = i.name.slice(0, idx) + `<strong style="color:var(--gold-light)">${i.name.slice(idx, idx + val.length)}</strong>` + i.name.slice(idx + val.length);
    }
    return `<div onmousedown="selectAC(this)">${label}</div>`;
  }).join('');
  dropdown.querySelectorAll('div').forEach((el, i) => {
    el.dataset.name = matches[i].name;
    el.dataset.id = matches[i].id;
  });
  dropdown.style.display = 'block';
}
function selectAC(el) {
  const wrapper = el.closest('.autocomplete-wrapper');
  wrapper.querySelector('.ing-input').value = el.dataset.name;
  wrapper.querySelector('.ing-id-input').value = el.dataset.id;
  el.closest('.autocomplete-dropdown').style.display = 'none';
}
document.addEventListener('click', e => {
  if (!e.target.closest('.autocomplete-wrapper')) {
    document.querySelectorAll('.autocomplete-dropdown').forEach(d => d.style.display = 'none');
  }
});

async function saveRecipe() {
  const name = document.getElementById('recipe-name').value.trim();
  if (!name) { toast('Veuillez entrer un nom'); return; }
  const rows = document.querySelectorAll('#form-ing-list .form-ing-row');
  const ingredients = [];
  rows.forEach(row => {
    const n = row.querySelector('.ing-input').value.trim();
    const idVal = row.querySelector('.ing-id-input').value.trim();
    const q = row.querySelector('.qty-input').value.trim();
    if (n) {
      const shake = row.querySelector('.ing-pill-toggle.active-shake') ? true : false;
      const optional = row.querySelector('.ing-pill-toggle.active-optional') ? true : false;
      const ingId = idVal ? parseInt(idVal) : null;
      if (ingId) {
        ingredients.push({ id: ingId, qty: q || '', shake, optional });
      } else {
        // ingr√©dient non trouv√© dans le catalogue ‚Äî on garde le nom en fallback
        ingredients.push({ name: n, qty: q || '', shake, optional });
      }
    }
  });
  const toppingRows = document.querySelectorAll('#form-topping-list .form-ing-row');
  const toppings = [];
  toppingRows.forEach(row => {
    const n = row.querySelector('.ing-input').value.trim();
    const idVal = row.querySelector('.ing-id-input').value.trim();
    const q = row.querySelector('.qty-input').value.trim();
    if (n) {
      const optional = row.querySelector('.ing-pill-toggle.active-optional') ? true : false;
      const ingId = idVal ? parseInt(idVal) : null;
      if (ingId) {
        toppings.push({ id: ingId, qty: q || '', optional });
      } else {
        toppings.push({ name: n, qty: q || '', optional });
      }
    }
  });
  const glass = document.getElementById('recipe-glass').value;
  const rating = parseInt(document.getElementById('recipe-rating').value) || 0;
  const notes = document.getElementById('recipe-notes').value.trim();
  const tags = { profil: [..._formTags.profil], texture: [..._formTags.texture], sucre: [..._formTags.sucre], complexite: [..._formTags.complexite] };
  const editId = document.getElementById('edit-id').value;
  if (editId) {
    await txPut('recipes', { id: parseInt(editId), name, ingredients, toppings, glass, rating, notes, tags });
    toast('Recette mise √† jour');
  } else {
    await txAdd('recipes', { name, ingredients, toppings, glass, rating, notes, tags });
    toast('Recette enregistr√©e');
  }
  startNew();
  renderManageList();
}

async function editRecipe(id) {
  showTab('manage');
  const r = await txGet('recipes', id);
  document.getElementById('edit-id').value = id;
  document.getElementById('recipe-name').value = r.name;
  document.getElementById('recipe-glass').value = r.glass || '';
  document.getElementById('recipe-notes').value = r.notes || '';
  document.getElementById('form-title').textContent = 'Modifier ‚Äî ' + r.name;
  setRating(r.rating || 0);
  loadTagsIntoForm(r.tags || null);
  renderFormIngs(r.ingredients, r.toppings || []);
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function deleteRecipe(id) {
  if (!confirm('Supprimer cette recette ?')) return;
  await txDelete('recipes', id);
  renderManageList();
  toast('Recette supprim√©e');
}

// ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2000);
}

// ‚îÄ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showLoading(on) {
  const el = document.getElementById('loading-overlay');
  el.style.display = on ? 'flex' : 'none';
}

function showError(msg) {
  document.getElementById('error-msg').textContent = msg;
  const el = document.getElementById('error-overlay');
  el.style.display = 'flex';
}

function showSetupModal() {
  const cfg = loadConfig();
  if (cfg) {
    document.getElementById('cfg-owner').value = cfg.owner || '';
    document.getElementById('cfg-repo').value = cfg.repo || '';
    document.getElementById('cfg-token').value = cfg.token || '';
  }
  document.getElementById('setup-modal').style.display = 'flex';
}

async function submitSetup() {
  const owner = document.getElementById('cfg-owner').value.trim();
  const repo  = document.getElementById('cfg-repo').value.trim();
  const token = document.getElementById('cfg-token').value.trim();
  const errEl = document.getElementById('setup-error');
  errEl.style.display = 'none';

  if (!owner || !repo || !token) {
    errEl.textContent = 'Veuillez remplir tous les champs.';
    errEl.style.display = 'block';
    return;
  }

  _ghConfig = { owner, repo, token };

  // Test de connexion
  showLoading(true);
  try {
    await ghRequest('GET', `/repos/${owner}/${repo}`);
    saveConfig(_ghConfig);
    document.getElementById('setup-modal').style.display = 'none';
    await loadFromGitHub();
  } catch(e) {
    showLoading(false);
    errEl.textContent = 'Erreur : ' + e.message + '. V√©rifiez votre token et le nom du repo.';
    errEl.style.display = 'block';
  }
}

// Bouton reconfigurer accessible depuis l'app
function reconfigure() {
  showSetupModal();
}


// ‚îÄ‚îÄ‚îÄ STICKY TABS ON SCROLL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const tabs = document.querySelector('.tabs');
  const header = document.querySelector('header');
  function onScroll() {
    const headerBottom = header.getBoundingClientRect().bottom;
    if (headerBottom <= 0) {
      tabs.classList.add('scrolled');
    } else {
      tabs.classList.remove('scrolled');
    }
  }
  window.addEventListener('scroll', onScroll, { passive: true });
})();

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
openDB();
</script>
</body>
</html>
